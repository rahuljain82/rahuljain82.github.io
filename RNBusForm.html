<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bus Booking - Running Ninjas</title>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9WH7YSXZ94"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9WH7YSXZ94');
  </script>
  
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 py-10">
  <div class="w-full flex justify-center mb-6">
    <img src="https://i.ibb.co/ZRLT8bH9/Whats-App-Image-2025-07-16-at-17-29-51.jpg" alt="Running Ninjas Logo" class="w-16 h-16 rounded-full" />
  </div>

  <div class="max-w-md mx-auto bg-white rounded-xl shadow p-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Ninja Discount & Bus Interest</h2>

    <form id="busBookingForm">
      <label class="block mb-3">Select Marathon
        <select id="marathonName" required class="w-full mt-1 p-2 border rounded"></select>
      </label>

      <label class="block mb-2">Enter Unique ID
        <input id="uniqueId" name="uniqueId" type="text" required class="w-full mt-1 p-2 border rounded" />
      </label>

      <button type="button" onclick="showForm()" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded mb-4">Show Booking Form</button>

      <div id="runnerDetails" class="hidden">
        <label class="block mb-2">Your Name
          <input id="name" name="name" type="text" required class="w-full mt-1 p-2 border rounded" />
        </label>
        
        <label class="block mb-2">Your Flat Number  
          <input id="flat" name="flat" type="text" required class="w-full mt-1 p-2 border rounded" />
        </label>

        <label class="block mb-2">
          Race Category
          <select id="raceCategory" name="raceCategory" required class="w-full mt-1 p-2 border rounded">
            <option value="">-- Select Race Category --</option>
            <option value="5k">5k</option>
            <option value="10k">10k</option>
            <option value="HM">HM (Half Marathon)</option>
            <option value="FM">FM (Full Marathon)</option>
          </select>
        </label>
        
        <label class="block mb-2 mt-4">
          Number of Bus Seats Required
          <input id="busSeats" name="busSeats" type="number" min="1" max="10" required class="w-full mt-1 p-2 border rounded" placeholder="Enter number of seats" />
        </label>

        <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 rounded mt-2">Count me In</button>
      </div>
    </form>

    <p id="formMessage" class="text-green-600 mt-4 hidden">Entry successful!</p>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxbo17aNByn1ikadvG9XCoIlNPBfVGwSLLa64mEpTxGT1pWYSRVZAtFidI-yYig7G8C3w/exec';

    // Load marathon options on page load
    window.onload = async function () {
      try {
        const res = await fetch(`${scriptURL}?listMarathons=true`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        const dropdown = document.getElementById("marathonName");

        if (data.marathons && data.marathons.length > 0) {
          data.marathons.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            dropdown.appendChild(opt);
          });
        } else {
          console.error("No marathons data received:", data);
          console.log("Full response:", JSON.stringify(data));
          alert("No marathons available. Check console for details and verify marathon data is in column E of your Google Sheet.");
        }
      } catch (error) {
        console.error("Error loading marathons:", error);
        alert(`Failed to load marathons: ${error.message}`);
      }
    };

    async function showForm() {
      const uniqueId = document.getElementById("uniqueId").value.trim();
      const marathonName = document.getElementById("marathonName").value;
      if (!uniqueId || !marathonName) return alert("Please fill both fields.");

      try {
        // Fetch runner details from running master sheet
        const res = await fetch(`${scriptURL}?uniqueId=${uniqueId}&marathonName=${encodeURIComponent(marathonName)}`);
        const data = await res.json();

        if (data.success) {
          // Auto-fill name and flat number
          document.getElementById("name").value = data.runner.name;
          document.getElementById("flat").value = data.runner.flat;
        } else {
          alert(data.error || "Runner not found. Please enter details manually.");
          // Clear the fields so user can enter manually
          document.getElementById("name").value = "";
          document.getElementById("flat").value = "";
        }

        document.getElementById("runnerDetails").classList.remove("hidden");
      } catch (error) {
        alert("Error fetching runner details. Please enter details manually.");
        document.getElementById("name").value = "";
        document.getElementById("flat").value = "";
        document.getElementById("runnerDetails").classList.remove("hidden");
      }
    }

    document.getElementById("busBookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formMessage = document.getElementById("formMessage");

      const formData = new FormData();
      formData.append("uniqueId", document.getElementById("uniqueId").value);
      formData.append("marathonName", document.getElementById("marathonName").value);
      formData.append("name", document.getElementById("name").value);
      formData.append("flat", document.getElementById("flat").value);
      formData.append("raceCategory", document.getElementById("raceCategory").value);
      formData.append("busSeats", document.getElementById("busSeats").value);

      const res = await fetch(scriptURL, {
        method: 'POST',
        body: formData
      });

      const responseText = await res.text();

      if (responseText.includes("Success")) {
        formMessage.classList.remove("hidden");
        document.getElementById("busBookingForm").reset();
        document.getElementById("runnerDetails").classList.add("hidden");
      } else {
        alert("Error: " + responseText);
      }
    });
  </script>
</body>
</html>
